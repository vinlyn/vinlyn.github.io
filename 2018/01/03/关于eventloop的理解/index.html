<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="vinlyn huang,hwlin1002@gmail.com"><title>关于eventloop的理解 · web</title><meta name="description" content="唠唠叨叨距离上一篇博客已经快一年，制定2018年的目标的时候，想了想2017年的基本没有完成，就把2017改个title，变成2018的然后就完事。在此希望18年不会再如此荒废。闲话不多说，进入正题。
写在前面众所周知，JavaScript是单线程的，任务都只在一个线程上面执行，那么意味着只有等前面"><meta name="keywords" content="Hexo,HTML,javascript,CSS,web,react,react native, vue, ploymer"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="Shortcut Icon" href="/images/avatar.png"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="sidebar-content"><div class="logo-title"><div class="title"><img src="/images/avatar.jpeg" style="width:127px;border-radius:50%;"><h3 title=""><a href="/">vinlyn</a></h3><div class="description"><p>你所想的或许不是你所想的.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/hwlin1002"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/u/1557870025"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/vinlyn"><i class="fa fa-github"></i></a></li><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li></ul></div><div class="footer"><div>© 2017 vinlyn</div><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai</a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/categories">分类</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/links">友链</a></li></div><!--.information--><!--  .back_btn--><!--    li--><!--      if is_post()--><!--        a.fa.fa-chevron-left(onclick="window.history.go(-1)") --><!--      else--><!--        a.fa.fa-chevron-left(onclick="window.history.go(-1)",style="display:none;") --><!--  .avatar--><!--    img(src=theme.avatar)--></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>关于eventloop的理解</a></h3></div><div class="post-content"><h4 id="唠唠叨叨"><a href="#唠唠叨叨" class="headerlink" title="唠唠叨叨"></a>唠唠叨叨</h4><p>距离上一篇博客已经快一年，制定2018年的目标的时候，想了想2017年的基本没有完成，就把2017改个title，变成2018的然后就完事。在此希望18年不会再如此荒废。闲话不多说，进入正题。</p>
<h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>众所周知，JavaScript是单线程的，任务都只在一个线程上面执行，那么意味着只有等前面一个任务处理完毕，才会执行后一个任务，如果前一个任务执行时间很长，后面的任务就只能一直等着，那么对于ajax、Dom操作，setTimeout、Promise等这些耗时的任务，JavaScript是怎么处理的（不同环境不同实现，这里应该是相应的JavaScript运行环境是怎么处理的），以不至于让程序处于一直等待的状态。event loop就是JavaScript用来实现异步操作，解决上述问题的一种机制。</p>
<h4 id="事件循环（event-loop）"><a href="#事件循环（event-loop）" class="headerlink" title="事件循环（event loop）"></a>事件循环（event loop）</h4><p>先讲讲什么是事件循环，<br>W3给的原文：To coordinate events, user interaction, scripts, rendering, networking, and so forth, user agents must use event loops as described in this section. There are two kinds of event loops: those for browsing contexts, and those for workers.（为了协调事件，用户交互，脚本，渲染，网络等，用户代理必须使用本节描述的事件循环。有两种事件循环：用于浏览上下文的事件循环，以及针对workers的事件循环）。这个解释跟上述为什么要有event loop相吻合。<br>事件循环是怎么做的：Javascript在主线程运行的时候，会有一个堆，一个执行栈，一个事件循环，一个或者多个任务队列。堆：相关的对象会被分配在堆中。在Javascript运行时，程序中的代码会依次进入执行栈中，然后执行，当遇到需要延时执行的事件时，如setTimeout，ajax，Dom操作等，Javascript就会把这些方法交给浏览器即（webAPI）的其他模块处理，使其不至于阻塞主线程的执行，等浏览器的模块处理完延时事件后，会把相应的回调压入任务队列中，等执行栈中的事件执行完毕后，主线程通过事件循环去任务队列中读取相应的回调，并进入执行栈进行执行。等执行栈的任务执行完之后，再去任务队列读取相应回调，如此往复。如下图：<br><img src="/images/eventloop/eventloop1.jpeg" style="width: 400px;"><br>下面用人家演讲的视频截图来说明这个过程。</p>
<p>程序等待执行时，执行栈，webAPI，任务队列都为空。<br><img src="/images/eventloop/eventloop2.jpeg" style="width: 600px;"></p>
<p>程序开始执行时，先将一个main()主方法加入执行栈中，此方法相当于程序的入口。<br><img src="/images/eventloop/eventloop3.jpeg" style="width: 600px;"></p>
<p>继续执行console.log(‘Hi’)方法，方法加入执行栈中；console.log属于webkit本身自己的方法，不属于webAPI的方法，立即执行并移出执行栈。输出Hi<br><img src="/images/eventloop/eventloop4.jpeg" style="width: 600px;"><br><img src="/images/eventloop/eventloop5.jpeg" style="width: 600px;"></p>
<p>程序继续往下执行，将setTimeout加入执行栈中并执行，系统将从webAPI中创建一个计时器，来处理倒计时的任务，然后setTimeout移出执行栈。<br><img src="/images/eventloop/eventloop6.jpeg" style="width: 600px;"><br><img src="/images/eventloop/eventloop7.jpeg" style="width: 600px;"><br><img src="/images/eventloop/eventloop8.jpeg" style="width: 600px;"></p>
<p>在setTimeout方法出栈执行后，立即将下面的console.log加入执行栈中，然后立即执行并移出执行栈。输出SJS。<br><img src="/images/eventloop/eventloop9.jpeg" style="width: 600px;"><br><img src="/images/eventloop/eventloop10.jpeg" style="width: 600px;"></p>
<p>主函数main()执行完毕，移出执行栈。<br><img src="/images/eventloop/eventloop11.jpeg" style="width: 600px;"></p>
<p>等webAPI，这里chrome是timer模块，处理setTimeout达到触发条件，就是延时5s后，会将回调方法压入任务队列中，也就是下面的task queue中。<br><img src="/images/eventloop/eventloop12.jpeg" style="width: 600px;"></p>
<p>当执行栈为空时，就通过事件循环去轮询任务队列，查看是否有任务需要执行，这时候就检查到了达到条件的回调方法，然后事件循环就把检查到的方法加入到执行栈中，并依次调用回调里面的方法，然后依次执行方法，运行console.log，输出there，都执行完毕，清空执行栈。事件循环继续去轮询任务队列，并如此反复。<br><img src="/images/eventloop/eventloop13.jpeg" style="width: 600px;"><br><img src="/images/eventloop/eventloop14.jpeg" style="width: 600px;"><br><img src="/images/eventloop/eventloop15.jpeg" style="width: 600px;"><br><img src="/images/eventloop/eventloop16.jpeg" style="width: 600px;"><br><img src="/images/eventloop/eventloop17.jpeg" style="width: 600px;"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>整个事件循环的过程大概是如此，每个环境中会包含的多个任务队列，不同的环境事件循环读取每个队列的先后顺序有可能是不一样的，但大体大同小异。web worker有自己的堆、栈、消息队列和事件循环，两个不同的运行时只能通过postMessage方法进行通信。Node环境的实现又是不一样(Node的要等做完功课后再来介绍)，当然这篇文章主要是看各位大神的文章拼凑而成的，只加上一点点自己的小理解，然后重复做工作加深一下自己的理解，下面会以这个为基础来讲讲setTimeout、setInterval、Dom事件、Promise是怎么工作的，执行顺序又是怎么样。<br>以上如有错误遗漏，望更正补充。</p>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p><a href="https://www.w3.org/TR/html5/webappapis.html#event-loops" target="_blank" rel="external">W3: Event loops</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop" target="_blank" rel="external">MDN：并发模型与事件循环</a><br><a href="http://latentflip.com/loupe/?code=ZnVuY3Rpb24gZ2V0WSAoeCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIHByb21pc2UocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiBwcm9taXNlVGltZW91dCgpIHsKICAgICAgICAgICAgcmVzb2x2ZSgoMyAqIHgpIC0gMSk7CiAgICAgICAgfSwgMCk7CiAgICB9KTsKfQoKZnVuY3Rpb24gZm9vIChiYXIsIGJheikgewogICAgdmFyIHggPSBiYXIgKiBiYXo7CgogICAgcmV0dXJuIGdldFkoeCkKICAgICAgICAudGhlbihmdW5jdGlvbiByZXR1cm5BcnJheSh5KSB7CiAgICAgICAgICAgIHJldHVybiBbIHgsIHkgXTsKICAgICAgICB9KTsKfQpzZXRUaW1lb3V0KGZ1bmN0aW9uIHRpbWVvdXQoKSB7CiAgICBjb25zb2xlLmxvZygndGltZW91dCcpCn0sIDApCgpmb28oMTAsIDIwKS50aGVuKGZ1bmN0aW9uIGxvZ01zZyhtc2dzKSB7CiAgICBjb25zb2xlLmxvZyhtc2cpOwp9KTs%3D!!!PGJ1dHRvbj5DbGljayBtZSE8L2J1dHRvbj4%3D" target="_blank" rel="external">事件循环示例，可在线写代码，观看过程</a><br><a href="http://www.alloyteam.com/2015/10/turning-to-javascript-series-from-settimeout-said-the-event-loop-model/" target="_blank" rel="external">【转向Javascript系列】从setTimeout说事件循环模型</a><br><a href="http://www.ruanyifeng.com/blog/2014/10/event-loop.html" target="_blank" rel="external">JavaScript 运行机制详解：再谈Event Loop</a><br><a href="http://blog.csdn.net/lin_credible/article/details/40143961" target="_blank" rel="external">【朴灵评注】JavaScript 运行机制详解：再谈Event Loop</a><br><a href="https://blog.sessionstack.com/how-javascript-works-event-loop-and-the-rise-of-async-programming-5-ways-to-better-coding-with-2f077c4438b5" target="_blank" rel="external">How JavaScript works: Event loop and the rise of Async programming + 5 ways to better coding with async/await</a><br><a href="https://vimeo.com/96425312" target="_blank" rel="external">Philip Roberts: Help, I’m stuck in an event-loop.</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-01-03</span><i class="fa fa-comment-o"></i><a href="/2018/01/03/关于eventloop的理解/#comments">评论</a><i class="fa fa-folder-o"></i><a href="/categories/JavaScript/" title="JavaScript" class="tag">JavaScript </a><i class="fa fa-tag"></i><a href="/tags/JavaScript/" title="JavaScript" class="tag">JavaScript </a></div></div></div></div><div class="share"><div class="evernote"> <a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"> <a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"> <a href="http://twitter.com/home?status=,http://yoursite.com/2018/01/03/关于eventloop的理解/,web,关于eventloop的理解,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2017/03/09/webpack常用配置说明/" title="Webpack配置详解" class="btn">下一篇</a></li></ul></div><a id="comments"></a><div data-thread-key="2018/01/03/关于eventloop的理解/" data-title="关于eventloop的理解" data-url="http://yoursite.com/2018/01/03/关于eventloop的理解/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"vinlyn"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>